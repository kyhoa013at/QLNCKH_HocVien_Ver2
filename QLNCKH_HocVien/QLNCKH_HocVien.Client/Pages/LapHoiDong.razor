@page "/laphoidong"

@using QLNCKH_HocVien.Client.Models
@using QLNCKH_HocVien.Client.Services
@inject HoiDongService HdService

<h3 class="text-danger fw-bold mb-4"><i class="bi bi-people-fill"></i> L?P H?I Ð?NG CH?M</h3>

@if (!string.IsNullOrEmpty(msgError)) { <div class="alert alert-danger">@msgError</div> }

<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <button class="nav-link @(vongHienTai == VongCham.SoLoai ? " active fw-bold" : "" )"
                @onclick="() => ChuyenVong(VongCham.SoLoai)">
            Vòng So Lo?i (1 ngu?i)
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(vongHienTai == VongCham.ChungKhao ? " active fw-bold" : "" )"
                @onclick="() => ChuyenVong(VongCham.ChungKhao)">
            Vòng Chung Kh?o (H?i d?ng)
        </button>
    </li>
</ul>

<div class="row">
    <div class="col-md-5">
        <div class="card border-danger shadow-sm">
            <div class="card-header bg-danger text-white">
                @(vongHienTai == VongCham.SoLoai ? "Phân công Ngu?i ch?m so lo?i" : "Thành l?p H?i d?ng Chung kh?o")
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Ch?n Chuyên d? (*)</label>
                    <select class="form-select" @bind="hdMoi.IdChuyenDe">
                        <option value="0">-- Ch?n Chuyên d? --</option>
                        @foreach(var cd in dsChuyenDe)
                        {
                        <option value="@cd.Id">@cd.MaSoCD - @cd.TenChuyenDe</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Ngày ch?m</label>
                    <input type="date" class="form-control" @bind="hdMoi.NgayCham" />
                </div>

                @if(vongHienTai == VongCham.ChungKhao)
                {
                <div class="mb-3">
                    <label class="form-label">Ð?a di?m</label>
                    <input type="text" class="form-control" @bind="hdMoi.DiaDiem" placeholder="Phòng h?p..." />
                </div>
                }

                <hr />
                <h6 class="text-danger">Thành viên:</h6>

                @if(vongHienTai == VongCham.SoLoai)
                {
                <div class="mb-2">
                    <label>Ngu?i ch?m (*)</label>
                    <select class="form-select" @bind="idGvSoLoai">
                        <option value="0">-- Ch?n Giáo viên --</option>
                        @foreach(var gv in dsGiaoVien) {
                        <option value="@gv.Id">@gv.MaSoCB - @gv.HoTen</option> }
                    </select>
                </div>
                }
                else
                {
                <div class="input-group mb-2">
                    <select class="form-select" @bind="idGvTam">
                        <option value="0">-- Ch?n thành viên --</option>
                        @foreach(var gv in dsGiaoVien) {
                        <option value="@gv.Id">@gv.HoTen</option> }
                    </select>
                    <select class="form-select" style="max-width: 120px;" @bind="vaiTroTam">
                        <option>Ch? t?ch</option>
                        <option>Thu ký</option>
                        <option>?y viên</option>
                    </select>
                    <button class="btn btn-outline-secondary" type="button" @onclick="ThemThanhVien">Thêm</button>
                </div>

                <ul class="list-group mb-3">
                    @foreach(var tv in hdMoi.ThanhViens)
                    {
                    var gv = dsGiaoVien.FirstOrDefault(x => x.Id == tv.IdGiaoVien);
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><b>@gv?.HoTen</b> (@tv.VaiTro)</span>
                        <button class="btn btn-sm btn-close" @onclick="() => hdMoi.ThanhViens.Remove(tv)"></button>
                    </li>
                    }
                </ul>
                }

                <button class="btn btn-danger w-100 mt-3" @onclick="LuuHoiDong">
                    <i class="bi bi-check-circle"></i> Xác nh?n Phân công
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-7">
        <div class="card">
            <div class="card-header">Danh sách phân công (@vongHienTai)</div>
            <div class="card-body">
                <table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Mã CÐ</th>
                            <th>Tên Chuyên Ð?</th>
                            <th>Ngày ch?m</th>
                            <th>Ngu?i ch?m / H?i d?ng</th>
                            <th>Xóa</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var item in dsHoiDong.Where(x => x.VongThi == vongHienTai))
                        {
                        var cd = dsChuyenDe.FirstOrDefault(x => x.Id == item.IdChuyenDe);
                        <tr>
                            <td>@cd?.MaSoCD</td>
                            <td>@cd?.TenChuyenDe</td>
                            <td>@item.NgayCham.ToString("dd/MM/yyyy")</td>
                            <td>
                                <ul class="list-unstyled mb-0 small">
                                    @foreach(var tv in item.ThanhViens)
                                    {
                                    var gv = dsGiaoVien.FirstOrDefault(x => x.Id == tv.IdGiaoVien);
                                    // S? d?ng IdDonViCongTac và danh sách ToChuc
                                    var dv = dsToChuc?.FirstOrDefault(d => d.Id == gv?.IdDonViCongTac)?.Ten ?? "Chua c?p nh?t";
                                    var cv = dsChucVu?.FirstOrDefault(c => c.IdChucVu == gv?.IdChucVu)?.TenChucVu ?? "Chua c?p nh?t";

                                    <li>
                                        @if(vongHienTai == VongCham.SoLoai)
                                        {
                                        <strong>@gv?.HoTen</strong> <br />
                                        <span class="text-muted">(@dv - @cv)</span>
                                        }
                                        else
                                        {
                                        <span>- @gv?.HoTen (@tv.VaiTro)</span>
                                        }
                                    </li>
                                    }
                                </ul>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" @onclick="()=>Xoa(item.Id)">Xóa</button>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@code {
    private VongCham vongHienTai = VongCham.SoLoai;
    private HoiDong hdMoi = new();
    private List<HoiDong>
    dsHoiDong = new();
    private string? msgError;

    private int idGvSoLoai = 0;
    private int idGvTam = 0;
    private string vaiTroTam = "?y viên";

    private List<ChuyenDeNCKH>
        dsChuyenDe = new();
        private List<GiaoVien>
            dsGiaoVien = new();

            // Ð?i CapDonVi thành ToChuc
            private List<ToChuc>
                dsToChuc = new();
                private List<ChucVu>
                    dsChucVu = new();

                    protected override async Task OnInitializedAsync()
                    {
                    try
                    {
                    var t1 = HdService.LayDsChuyenDe();
                    var t2 = HdService.LayDsGiaoVien();
                    var t3 = HdService.LayDsHoiDong();
                    var t4 = HdService.LayDsToChuc(); // G?i hàm m?i
                    var t5 = HdService.LayDsChucVu();

                    await Task.WhenAll(t1, t2, t3, t4, t5);
                    dsChuyenDe = t1.Result;
                    dsGiaoVien = t2.Result;
                    dsHoiDong = t3.Result;
                    dsToChuc = t4.Result; // Gán vào list ToChuc
                    dsChucVu = t5.Result;
                    }
                    catch(Exception ex)
                    {
                    msgError = "L?i load: " + ex.Message;
                    }
                    }

                    private void ChuyenVong(VongCham v)
                    {
                    vongHienTai = v;
                    hdMoi = new HoiDong { VongThi = v };
                    idGvSoLoai = 0;
                    msgError = null;
                    }

                    private void ThemThanhVien()
                    {
                    if (idGvTam == 0) return;
                    if (hdMoi.ThanhViens.Any(x => x.IdGiaoVien == idGvTam)) return;

                    hdMoi.ThanhViens.Add(new ThanhVienHoiDong
                    {
                    IdGiaoVien = idGvTam,
                    VaiTro = vaiTroTam
                    });
                    }

                    private async Task LuuHoiDong()
                    {
                    if (hdMoi.IdChuyenDe == 0) { msgError = "Chua ch?n chuyên d?"; return; }

                    if (vongHienTai == VongCham.SoLoai)
                    {
                    if (idGvSoLoai == 0) { msgError = "Chua ch?n ngu?i ch?m so lo?i"; return; }
                    hdMoi.ThanhViens.Clear();
                    hdMoi.ThanhViens.Add(new ThanhVienHoiDong { IdGiaoVien = idGvSoLoai, VaiTro = "Ngu?i ch?m" });
                    }
                    else
                    {
                    if (hdMoi.ThanhViens.Count == 0) { msgError = "H?i d?ng ph?i có ít nh?t 1 thành viên"; return; }
                    }

                    try
                    {
                    await HdService.TaoHoiDong(hdMoi);
                    dsHoiDong = await HdService.LayDsHoiDong();
                    ChuyenVong(vongHienTai);
                    msgError = null;
                    }
                    catch(Exception ex)
                    {
                    msgError = ex.Message;
                    }
                    }

                    private async Task Xoa(int id)
                    {
                        if(!await JS.InvokeAsync<bool>("confirm", "B?n mu?n xóa phân công này?")) return;
    
                        msgError = null; // Reset thông báo l?i cu
                        try 
                        {
                            await HdService.XoaHoiDong(id);
                            dsHoiDong = await HdService.LayDsHoiDong(); // T?i l?i danh sách m?i
                        }
                        catch (Exception ex)
                        {
                            msgError = ex.Message; // Hi?n l?i d? lên màn hình
                        }
                    }

            [Inject] IJSRuntime JS { get; set; }
}
