@page "/capnhatketqua"

@using QLNCKH_HocVien.Client.Models
@using QLNCKH_HocVien.Client.Services
@inject KetQuaService KqService

<h3 class="text-primary fw-bold mb-4">C?P NH?T K?T QU? CHUYÊN Ð?</h3>

<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <button class="nav-link @(tab == 1 ? "active fw-bold" : "")" @onclick="() => tab = 1">Vòng So Lo?i</button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(tab == 2 ? "active fw-bold" : "")" @onclick="() => tab = 2">Vòng Chung Kh?o</button>
    </li>
</ul>

@if (tab == 1)
{
    // --- GIAO DI?N VÒNG SO LO?I ---
    <div class="mb-3">
        <button class="btn btn-outline-primary" @onclick="AutoXetDuyet">
            <i class="bi bi-lightning-fill"></i> T? d?ng xét duy?t Top 15
        </button>
    </div>

    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>Mã CÐ</th>
                <th>Tên Chuyên Ð?</th>
                <th width="150">Ði?m ch?m</th>
                <th width="150">K?t qu?</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var cd in dsChuyenDe)
            {
                // Tìm k?t qu? hi?n có trong list (n?u chua có thì t?o m?i ?o d? bind)
                var kq = dsKqSoLoai.FirstOrDefault(x => x.IdChuyenDe == cd.Id)
                ?? new KetQuaSoLoai { IdChuyenDe = cd.Id };

                <tr>
                    <td>@cd.MaSoCD</td>
                    <td>@cd.TenChuyenDe</td>
                    <td>
                        <input type="number" step="0.1" min="0" max="10" class="form-control"
                               @bind="kq.DiemSo" />
                    </td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" @bind="kq.KetQua" />
                            <label class="form-check-label">@(kq.KetQua ? "Ðu?c di ti?p" : "Lo?i")</label>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" @onclick="() => LuuSoLoai(kq)">Luu</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    // --- GIAO DI?N VÒNG CHUNG KH?O ---
    <div class="alert alert-info">Ch? hi?n th? các d? tài dã qua vòng so lo?i và có H?i d?ng ch?m Chung kh?o.</div>

    @foreach (var cd in dsChuyenDe.Where(x => IsPassSoLoai(x.Id)))
    {
        // Tìm h?i d?ng chung kh?o c?a d? tài này
        var hd = dsHoiDong.FirstOrDefault(x => x.IdChuyenDe == cd.Id && x.VongThi == VongCham.ChungKhao);
        if (hd == null) continue;

        <div class="card mb-3 border-primary">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <span>
                    <strong>@cd.MaSoCD</strong> - @cd.TenChuyenDe
                </span>
                <span class="badge bg-primary fs-6">
                    ÐI?M TRUNG BÌNH: @CalcAverage(cd.Id).ToString("0.00")
                </span>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Thành viên h?i d?ng</th>
                            <th>Vai trò</th>
                            <th width="150">Ði?m ch?m</th>
                            <th>Luu</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var tv in hd.ThanhViens)
                        {
                            var gv = dsGiaoVien.FirstOrDefault(x => x.Id == tv.IdGiaoVien);
                            // Tìm phi?u ch?m c?a GV này (n?u chua có t?o m?i)
                            var pc = GetPhieuCham(cd.Id, tv.IdGiaoVien);

                            <tr>
                                <td>@gv?.HoTen</td>
                                <td>@tv.VaiTro</td>
                                <td>
                                    <input type="number" step="0.1" min="0" max="10" class="form-control form-control-sm"
                                           @bind="pc.Diem" />
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-success" @onclick="() => LuuPhieu(pc)">
                                        <i class="bi bi-check"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
}

@code {
    private int tab = 1;
    private List<ChuyenDeNCKH> dsChuyenDe = new();
    private List<KetQuaSoLoai> dsKqSoLoai = new();

    // Data chung kh?o
    private List<HoiDong> dsHoiDong = new();
    private List<GiaoVien> dsGiaoVien = new();
    private List<PhieuCham> dsPhieuChamAll = new(); // Load t?t c? phi?u ch?m v? client d? tính TB

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        var t1 = KqService.GetChuyenDe();
        var t2 = KqService.GetSoLoai();
        var t3 = KqService.GetHoiDong();
        var t4 = KqService.GetGiaoVien();
        // Load t?m phi?u ch?m c?a d? tài d?u tiên d? demo, th?c t? nên load all ho?c load on demand
        // ? dây tôi dùng gi?i pháp don gi?n: Load phi?u ch?m khi render (s? t?i uu sau)

        await Task.WhenAll(t1, t2, t3, t4);
        dsChuyenDe = t1.Result;
        dsKqSoLoai = t2.Result;
        dsHoiDong = t3.Result;
        dsGiaoVien = t4.Result;

        // Load all phi?u ch?m d? tính di?m TB (c?n t?o thêm API Get All PhieuCham n?u mu?n nhanh)
        // T?m th?i ta dùng vòng l?p load (hoi ch?m n?u nhi?u data, nhung ok cho demo)
        // dsPhieuChamAll.Clear();
        // foreach (var cd in dsChuyenDe)
        // {
        //     var pcs = await KqService.GetPhieuCham(cd.Id);
        //     dsPhieuChamAll.AddRange(pcs);
        // }

        // ? Load t?t c? phi?u ch?m 1 l?n - Nhanh hon nhi?u
        dsPhieuChamAll = await KqService.GetAllPhieuCham();
    }

    // --- LOGIC SO LO?I ---
    private async Task LuuSoLoai(KetQuaSoLoai item)
    {
        await KqService.SaveSoLoai(item);
        dsKqSoLoai = await KqService.GetSoLoai(); // Refresh
    }

    private async Task AutoXetDuyet()
    {
        await KqService.AutoTop15();
        await LoadData();
    }

    private bool IsPassSoLoai(int idCD)
    {
        return dsKqSoLoai.Any(x => x.IdChuyenDe == idCD && x.KetQua == true);
    }

    // --- LOGIC CHUNG KH?O ---

    // Helper l?y phi?u ch?m t? list local, n?u không có thì new
    private PhieuCham GetPhieuCham(int idCD, int idGV)
    {
        var pc = dsPhieuChamAll.FirstOrDefault(x => x.IdChuyenDe == idCD && x.IdGiaoVien == idGV);
        if (pc == null)
        {
            pc = new PhieuCham { IdChuyenDe = idCD, IdGiaoVien = idGV };
            dsPhieuChamAll.Add(pc);
        }
        return pc;
    }

    private async Task LuuPhieu(PhieuCham pc)
    {
        await KqService.SavePhieuCham(pc);
        // Refresh l?i list phi?u ch?m c?a d? tài này d? c?p nh?t di?m TB
        var newPcs = await KqService.GetPhieuCham(pc.IdChuyenDe);
        dsPhieuChamAll.RemoveAll(x => x.IdChuyenDe == pc.IdChuyenDe);
        dsPhieuChamAll.AddRange(newPcs);
    }

    private double CalcAverage(int idCD)
    {
        var scores = dsPhieuChamAll.Where(x => x.IdChuyenDe == idCD && x.Diem > 0).Select(x => x.Diem).ToList();
        if (scores.Count == 0) return 0;
        return scores.Average();
    }
}
