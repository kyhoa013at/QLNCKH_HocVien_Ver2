@page "/capnhatketqua"
@rendermode InteractiveServer
@using QLNCKH_HocVien.Client.Models
@using QLNCKH_HocVien.Client.Services
@inject KetQuaService KqService

<h3 class="text-primary fw-bold mb-4">CẬP NHẬT KẾT QUẢ CHUYÊN ĐỀ</h3>

<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <button class="nav-link @(tab == 1 ? "active fw-bold" : "")" @onclick="() => tab = 1">Vòng Sơ Loại</button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(tab == 2 ? "active fw-bold" : "")" @onclick="() => tab = 2">Vòng Chung Khảo</button>
    </li>
</ul>

@if (tab == 1)
{
    // --- GIAO DIỆN VÒNG SƠ LOẠI ---
    <div class="mb-3">
        <button class="btn btn-outline-primary" @onclick="AutoXetDuyet">
            <i class="bi bi-lightning-fill"></i> Tự động xét duyệt Top 15
        </button>
    </div>

    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th>Mã CĐ</th>
                <th>Tên Chuyên Đề</th>
                <th width="150">Điểm chấm</th>
                <th width="150">Kết quả</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var cd in dsChuyenDe)
            {
                // Tìm kết quả hiện có trong list (nếu chưa có thì tạo mới ảo để bind)
                var kq = dsKqSoLoai.FirstOrDefault(x => x.IdChuyenDe == cd.Id)
                ?? new KetQuaSoLoai { IdChuyenDe = cd.Id };

                <tr>
                    <td>@cd.MaSoCD</td>
                    <td>@cd.TenChuyenDe</td>
                    <td>
                        <input type="number" step="0.1" min="0" max="10" class="form-control"
                               @bind="kq.DiemSo" />
                    </td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" @bind="kq.KetQua" />
                            <label class="form-check-label">@(kq.KetQua ? "Được đi tiếp" : "Loại")</label>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" @onclick="() => LuuSoLoai(kq)">Lưu</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    // --- GIAO DIỆN VÒNG CHUNG KHẢO ---
    <div class="alert alert-info">Chỉ hiển thị các đề tài đã qua vòng sơ loại và có Hội đồng chấm Chung khảo.</div>

    @foreach (var cd in dsChuyenDe.Where(x => IsPassSoLoai(x.Id)))
    {
        // Tìm hội đồng chung khảo của đề tài này
        var hd = dsHoiDong.FirstOrDefault(x => x.IdChuyenDe == cd.Id && x.VongThi == VongCham.ChungKhao);
        if (hd == null) continue;

        <div class="card mb-3 border-primary">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <span>
                    <strong>@cd.MaSoCD</strong> - @cd.TenChuyenDe
                </span>
                <span class="badge bg-primary fs-6">
                    ĐIỂM TRUNG BÌNH: @CalcAverage(cd.Id).ToString("0.00")
                </span>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Thành viên hội đồng</th>
                            <th>Vai trò</th>
                            <th width="150">Điểm chấm</th>
                            <th>Lưu</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var tv in hd.ThanhViens)
                        {
                            var gv = dsGiaoVien.FirstOrDefault(x => x.Id == tv.IdGiaoVien);
                            // Tìm phiếu chấm của GV này (nếu chưa có tạo mới)
                            var pc = GetPhieuCham(cd.Id, tv.IdGiaoVien);

                            <tr>
                                <td>@gv?.HoTen</td>
                                <td>@tv.VaiTro</td>
                                <td>
                                    <input type="number" step="0.1" min="0" max="10" class="form-control form-control-sm"
                                           @bind="pc.Diem" />
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-success" @onclick="() => LuuPhieu(pc)">
                                        <i class="bi bi-check"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
}

@code {
    private int tab = 1;
    private List<ChuyenDeNCKH> dsChuyenDe = new();
    private List<KetQuaSoLoai> dsKqSoLoai = new();

    // Data chung khảo
    private List<HoiDong> dsHoiDong = new();
    private List<GiaoVien> dsGiaoVien = new();
    private List<PhieuCham> dsPhieuChamAll = new(); // Load tất cả phiếu chấm về client để tính TB

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        var t1 = KqService.GetChuyenDe();
        var t2 = KqService.GetSoLoai();
        var t3 = KqService.GetHoiDong();
        var t4 = KqService.GetGiaoVien();
        // Load tạm phiếu chấm của đề tài đầu tiên để demo, thực tế nên load all hoặc load on demand
        // Ở đây tôi dùng giải pháp đơn giản: Load phiếu chấm khi render (sẽ tối ưu sau)

        await Task.WhenAll(t1, t2, t3, t4);
        dsChuyenDe = t1.Result;
        dsKqSoLoai = t2.Result;
        dsHoiDong = t3.Result;
        dsGiaoVien = t4.Result;

        // Load all phiếu chấm để tính điểm TB (cần tạo thêm API Get All PhieuCham nếu muốn nhanh)
        // Tạm thời ta dùng vòng lặp load (hơi chậm nếu nhiều data, nhưng ok cho demo)
        // dsPhieuChamAll.Clear();
        // foreach (var cd in dsChuyenDe)
        // {
        //     var pcs = await KqService.GetPhieuCham(cd.Id);
        //     dsPhieuChamAll.AddRange(pcs);
        // }

        // ✅ Load tất cả phiếu chấm 1 lần - Nhanh hơn nhiều
        dsPhieuChamAll = await KqService.GetAllPhieuCham();
    }

    // --- LOGIC SƠ LOẠI ---
    private async Task LuuSoLoai(KetQuaSoLoai item)
    {
        await KqService.SaveSoLoai(item);
        dsKqSoLoai = await KqService.GetSoLoai(); // Refresh
    }

    private async Task AutoXetDuyet()
    {
        await KqService.AutoTop15();
        await LoadData();
    }

    private bool IsPassSoLoai(int idCD)
    {
        return dsKqSoLoai.Any(x => x.IdChuyenDe == idCD && x.KetQua == true);
    }

    // --- LOGIC CHUNG KHẢO ---

    // Helper lấy phiếu chấm từ list local, nếu không có thì new
    private PhieuCham GetPhieuCham(int idCD, int idGV)
    {
        var pc = dsPhieuChamAll.FirstOrDefault(x => x.IdChuyenDe == idCD && x.IdGiaoVien == idGV);
        if (pc == null)
        {
            pc = new PhieuCham { IdChuyenDe = idCD, IdGiaoVien = idGV };
            dsPhieuChamAll.Add(pc);
        }
        return pc;
    }

    private async Task LuuPhieu(PhieuCham pc)
    {
        await KqService.SavePhieuCham(pc);
        // Refresh lại list phiếu chấm của đề tài này để cập nhật điểm TB
        var newPcs = await KqService.GetPhieuCham(pc.IdChuyenDe);
        dsPhieuChamAll.RemoveAll(x => x.IdChuyenDe == pc.IdChuyenDe);
        dsPhieuChamAll.AddRange(newPcs);
    }

    private double CalcAverage(int idCD)
    {
        var scores = dsPhieuChamAll.Where(x => x.IdChuyenDe == idCD && x.Diem > 0).Select(x => x.Diem).ToList();
        if (scores.Count == 0) return 0;
        return scores.Average();
    }
}