@page "/quanlysinhvien"
@using MudBlazor
@using QLNCKH_HocVien.Client.Models
@using QLNCKH_HocVien.Client.Services
@using QLNCKH_HocVien.Client.Exceptions
@using QLNCKH_HocVien.Client.Shared
@inject SinhVienService SvService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageHeader Title="QUẢN LÝ SINH VIÊN" 
            Subtitle="Danh sách và quản lý thông tin sinh viên" 
            Icon="@Icons.Material.Filled.School">
    <MudButton Variant="Variant.Filled" 
               Color="Color.Surface" 
               StartIcon="@Icons.Material.Filled.Add"
               OnClick="OpenAddDialog"
               Disabled="@_isLoading">
        Thêm sinh viên
    </MudButton>
    <MudButton Variant="Variant.Outlined" 
               Color="Color.Surface" 
               StartIcon="@Icons.Material.Filled.CloudDownload"
               Href="@SvService.GetExportUrl()"
               Target="_blank">
        Xuất Excel
    </MudButton>
</PageHeader>

<MudPaper Elevation="2" Class="pa-4">
    @* Search Bar *@
    <div class="d-flex gap-3 mb-4 flex-wrap">
        <MudTextField @bind-Value="_searchText"
                      Placeholder="Tìm kiếm theo mã SV, họ tên, lớp..."
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true"
                      DebounceInterval="500"
                      OnDebounceIntervalElapsed="OnSearchChanged"
                      Style="max-width: 400px;"
                      Class="flex-grow-1" />
        
        <MudSelect T="int" 
                   Value="_pageSize" 
                   Label="Hiển thị"
                   Variant="Variant.Outlined"
                   Style="width: 120px;"
                   ValueChanged="@(async (int size) => await OnPageSizeChanged(size))">
            <MudSelectItem Value="5">5 / trang</MudSelectItem>
            <MudSelectItem Value="10">10 / trang</MudSelectItem>
            <MudSelectItem Value="25">25 / trang</MudSelectItem>
            <MudSelectItem Value="50">50 / trang</MudSelectItem>
        </MudSelect>
    </div>

    @* Data Table *@
    @if (_isLoading && _sinhViens.Count == 0)
    {
        <TableSkeleton Rows="5" Columns="8" />
    }
    else
    {
        <MudTable Items="@_sinhViens" 
                  Hover="true" 
                  Striped="true"
                  Dense="true"
                  Loading="@_isLoading"
                  LoadingProgressColor="Color.Primary"
                  Elevation="0"
                  Class="mb-4">
            <HeaderContent>
                <MudTh Style="width: 60px;">STT</MudTh>
                <MudTh>Mã SV</MudTh>
                <MudTh>Họ và tên</MudTh>
                <MudTh>Ngày sinh</MudTh>
                <MudTh>Giới tính</MudTh>
                <MudTh>Lớp</MudTh>
                <MudTh>Ngành</MudTh>
                <MudTh>Quê quán</MudTh>
                <MudTh Style="width: 150px;">Thao tác</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="STT" Style="text-align: center;">
                    @((_currentPage - 1) * _pageSize + _sinhViens.IndexOf(context) + 1)
                </MudTd>
                <MudTd DataLabel="Mã SV">
                    <MudChip T="string" Color="Color.Primary" Size="Size.Small">@context.MaSV</MudChip>
                </MudTd>
                <MudTd DataLabel="Họ tên">
                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.HoTen</MudText>
                </MudTd>
                <MudTd DataLabel="Ngày sinh">@context.NgaySinh?.ToString("dd/MM/yyyy")</MudTd>
                <MudTd DataLabel="Giới tính">
                    @if (context.GioiTinh == "Nam")
                    {
                        <MudChip T="string" Color="Color.Info" Size="Size.Small">Nam</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Secondary" Size="Size.Small">Nữ</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Lớp">@context.Lop</MudTd>
                <MudTd DataLabel="Ngành">
                    @(_dsNganh.FirstOrDefault(n => n.IdLVNganh == context.IdNganh)?.TenLVNganh ?? "-")
                </MudTd>
                <MudTd DataLabel="Quê quán">
                    @(_dsTinh.FirstOrDefault(t => t.IdTinh == context.IdTinh)?.TenTinh ?? "-")
                </MudTd>
                <MudTd DataLabel="Thao tác">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                   Color="Color.Primary" 
                                   Size="Size.Small"
                                   OnClick="@(() => OpenEditDialog(context))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                   Color="Color.Error" 
                                   Size="Size.Small"
                                   OnClick="@(() => ConfirmDelete(context))" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudAlert Severity="Severity.Info" Class="my-4">
                    @if (string.IsNullOrEmpty(_searchText))
                    {
                        <span>Chưa có dữ liệu sinh viên</span>
                    }
                    else
                    {
                        <span>Không tìm thấy sinh viên phù hợp với "@_searchText"</span>
                    }
                </MudAlert>
            </NoRecordsContent>
        </MudTable>

        @* Pagination *@
        <div class="d-flex justify-space-between align-center flex-wrap gap-2">
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Hiển thị @((_currentPage - 1) * _pageSize + 1) - @Math.Min(_currentPage * _pageSize, _totalCount) 
                trong tổng số @_totalCount sinh viên
            </MudText>
            
            <MudPagination Count="@_totalPages" 
                          Selected="@_currentPage"
                          ShowFirstButton="true"
                          ShowLastButton="true"
                          Color="Color.Primary"
                          Variant="Variant.Outlined"
                          SelectedChanged="@(async (int page) => await OnPageChanged(page))" />
        </div>
    }
</MudPaper>

@* Add/Edit Dialog *@
<MudDialog @bind-Visible="_showFormDialog" Options="@_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(_isEditMode ? Icons.Material.Filled.Edit : Icons.Material.Filled.PersonAdd)" Class="mr-2" />
            @(_isEditMode ? "Cập nhật sinh viên" : "Thêm sinh viên mới")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_formIsValid">
            <MudGrid Spacing="3">
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_sinhVienForm.MaSV"
                                  Label="Mã sinh viên *"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Vui lòng nhập mã sinh viên"
                                  Disabled="@_isEditMode" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_sinhVienForm.HoTen"
                                  Label="Họ và tên *"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Vui lòng nhập họ tên" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudDatePicker @bind-Date="_sinhVienForm.NgaySinh"
                                   Label="Ngày sinh"
                                   Variant="Variant.Outlined"
                                   DateFormat="dd/MM/yyyy"
                                   Placeholder="Chọn ngày sinh" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="_sinhVienForm.GioiTinh"
                               Label="Giới tính"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="@("Nam")">Nam</MudSelectItem>
                        <MudSelectItem Value="@("Nữ")">Nữ</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_sinhVienForm.IdTinh"
                               Label="Quê quán"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var t in _dsTinh)
                        {
                            <MudSelectItem T="int?" Value="@t.IdTinh">@t.TenTinh</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_sinhVienForm.IdNganh"
                               Label="Ngành học"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var n in _dsNganh)
                        {
                            <MudSelectItem T="int?" Value="@n.IdLVNganh">@n.TenLVNganh</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_sinhVienForm.Lop"
                                  Label="Lớp"
                                  Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_sinhVienForm.SoDienThoai"
                                  Label="Số điện thoại"
                                  Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_sinhVienForm.IdDanToc"
                               Label="Dân tộc"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var d in _dsDanToc)
                        {
                            <MudSelectItem T="int?" Value="@d.IdDanToc">@d.TenDanToc</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" 
                               @bind-Value="_sinhVienForm.IdTonGiao"
                               Label="Tôn giáo"
                               Variant="Variant.Outlined"
                               Clearable="true">
                        @foreach (var t in _dsTonGiao)
                        {
                            <MudSelectItem T="int?" Value="@t.IdTonGiao">@t.TenTonGiao</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseFormDialog" Disabled="@_isSaving">Hủy</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled"
                   OnClick="SaveSinhVien"
                   Disabled="@(!_formIsValid || _isSaving)">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Đang lưu...</span>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1" />
                <span>Lưu</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    // Data
    private List<SinhVien> _sinhViens = new();
    private List<Tinh> _dsTinh = new();
    private List<DanToc> _dsDanToc = new();
    private List<TonGiao> _dsTonGiao = new();
    private List<Nganh> _dsNganh = new();

    // Pagination
    private int _currentPage = 1;
    private int _pageSize = 10;
    private int _totalCount = 0;
    private int _totalPages => (int)Math.Ceiling(_totalCount / (double)_pageSize);

    // Search
    private string _searchText = "";

    // Form
    private SinhVien _sinhVienForm = new();
    private bool _showFormDialog = false;
    private bool _isEditMode = false;
    private bool _formIsValid = false;
    private bool _isSaving = false;
    private MudForm? _form;

    // Loading
    private bool _isLoading = false;

    // Dialog options
    private DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true,
        CloseOnEscapeKey = true,
        BackdropClick = false
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load catalogs in parallel
            var tasks = new[]
            {
                LoadCatalogAsync(async () => _dsTinh = await SvService.LayDsTinh()),
                LoadCatalogAsync(async () => _dsDanToc = await SvService.LayDsDanToc()),
                LoadCatalogAsync(async () => _dsTonGiao = await SvService.LayDsTonGiao()),
                LoadCatalogAsync(async () => _dsNganh = await SvService.LayDsNganh())
            };
            await Task.WhenAll(tasks);

            // Load data
            await LoadDataAsync();
        }
        catch (UnauthorizedException)
        {
            Navigation.NavigateTo("/access-denied", forceLoad: true);
        }
    }

    private async Task LoadCatalogAsync(Func<Task> action)
    {
        try { await action(); } catch { }
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();

            var result = await SvService.LayDanhSachPhanTrang(_currentPage, _pageSize, _searchText);
            _sinhViens = result.Data ?? new List<SinhVien>();
            _totalCount = result.TotalCount;
        }
        catch (UnauthorizedException)
        {
            Navigation.NavigateTo("/access-denied", forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi tải dữ liệu: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OnSearchChanged(string value)
    {
        _searchText = value;
        _currentPage = 1;
        await LoadDataAsync();
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadDataAsync();
    }

    private async Task OnPageSizeChanged(int size)
    {
        _pageSize = size;
        _currentPage = 1;
        await LoadDataAsync();
    }

    private void OpenAddDialog()
    {
        _sinhVienForm = new SinhVien();
        _isEditMode = false;
        _showFormDialog = true;
    }

    private void OpenEditDialog(SinhVien sv)
    {
        _sinhVienForm = new SinhVien
        {
            Id = sv.Id,
            MaSV = sv.MaSV,
            HoTen = sv.HoTen,
            NgaySinh = sv.NgaySinh,
            GioiTinh = sv.GioiTinh,
            IdTinh = sv.IdTinh,
            IdNganh = sv.IdNganh,
            Lop = sv.Lop,
            SoDienThoai = sv.SoDienThoai,
            IdDanToc = sv.IdDanToc,
            IdTonGiao = sv.IdTonGiao,
            IdChucVu = sv.IdChucVu,
            ChuyenNganh = sv.ChuyenNganh
        };
        _isEditMode = true;
        _showFormDialog = true;
    }

    private void CloseFormDialog()
    {
        if (!_isSaving)
        {
            _showFormDialog = false;
        }
    }

    private async Task SaveSinhVien()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_formIsValid) return;
        }

        try
        {
            _isSaving = true;

            if (_isEditMode)
            {
                var result = await SvService.CapNhatSinhVien(_sinhVienForm);
                if (result.Success)
                {
                    Snackbar.Add("Cập nhật sinh viên thành công!", Severity.Success);
                    _showFormDialog = false;
                    await LoadDataAsync();
                }
                else
                {
                    Snackbar.Add(result.Message, Severity.Error);
                }
            }
            else
            {
                var result = await SvService.ThemSinhVien(_sinhVienForm);
                if (result.Success)
                {
                    Snackbar.Add("Thêm sinh viên thành công!", Severity.Success);
                    _showFormDialog = false;
                    await LoadDataAsync();
                }
                else
                {
                    Snackbar.Add(result.Message, Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ConfirmDelete(SinhVien sv)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Bạn có chắc chắn muốn xóa sinh viên '{sv.HoTen}' ({sv.MaSV})?",
            ["ConfirmText"] = "Xóa",
            ["Icon"] = Icons.Material.Filled.DeleteForever,
            ["IconColor"] = Color.Error
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Xác nhận xóa", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await DeleteSinhVien(sv.Id);
        }
    }

    private async Task DeleteSinhVien(int id)
    {
        try
        {
            _isLoading = true;
            var result = await SvService.XoaSinhVien(id);
            
            if (result.Success)
            {
                Snackbar.Add("Xóa sinh viên thành công!", Severity.Success);
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add(result.Message, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Lỗi xóa: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
